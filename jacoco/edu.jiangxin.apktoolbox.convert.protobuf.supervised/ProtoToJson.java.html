<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProtoToJson.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ApkToolBoxGUI</a> &gt; <a href="index.source.html" class="el_package">edu.jiangxin.apktoolbox.convert.protobuf.supervised</a> &gt; <span class="el_source">ProtoToJson.java</span></div><h1>ProtoToJson.java</h1><pre class="source lang-java linenums">package edu.jiangxin.apktoolbox.convert.protobuf.supervised;

import com.google.protobuf.Descriptors;
import com.google.protobuf.DynamicMessage;
import com.google.protobuf.InvalidProtocolBufferException;
import com.google.protobuf.util.JsonFormat;

import java.io.IOException;
import java.io.UncheckedIOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Comparator;
import java.util.Objects;
import java.util.Optional;

public final class ProtoToJson {
    public static ProtoToJson fromCache(final DescriptorCache cache) {
<span class="nc" id="L18">        Objects.requireNonNull(cache);</span>

<span class="nc" id="L20">        return new ProtoToJson(cache);</span>
    }

    public static ProtoToJson fromEmptyCache() {
<span class="nc" id="L24">        return new ProtoToJson(DescriptorCache.emptyCache());</span>
    }

    private final DescriptorCache cache;
<span class="nc" id="L28">    private final JsonFormat.Printer printer = JsonFormat.printer();</span>

<span class="nc" id="L30">    private ProtoToJson(final DescriptorCache cache) {</span>
<span class="nc" id="L31">        this.cache = Objects.requireNonNull(cache);</span>
<span class="nc" id="L32">    }</span>

    public DescriptorCache getCache() {
<span class="nc" id="L35">        return cache;</span>
    }

    public String toJson(final Path messageFile) {
<span class="nc" id="L39">        Objects.requireNonNull(messageFile);</span>

        try {
<span class="nc" id="L42">            return toJson(Files.readAllBytes(messageFile), (String) null);</span>
<span class="nc" id="L43">        } catch (final IOException e) {</span>
<span class="nc" id="L44">            throw new UncheckedIOException(e);</span>
        }
    }

    public String toJson(final byte[] messageRaw) {
<span class="nc" id="L49">        Objects.requireNonNull(messageRaw);</span>

<span class="nc" id="L51">        return toJson(messageRaw, (String) null);</span>
    }

    public String toJson(final Path messageFile, final String messageTypeName) {
<span class="nc" id="L55">        Objects.requireNonNull(messageFile);</span>

        try {
<span class="nc" id="L58">            return toJson(Files.readAllBytes(messageFile), messageTypeName);</span>
<span class="nc" id="L59">        } catch (final IOException e) {</span>
<span class="nc" id="L60">            throw new UncheckedIOException(e);</span>
        }
    }

    public String toJson(final byte[] messageRaw, final String messageTypeName) {
<span class="nc" id="L65">        Objects.requireNonNull(messageRaw);</span>

<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (messageTypeName == null) {</span>
<span class="nc" id="L68">            final Optional&lt;DynamicMessage&gt; message = parseWithBestMatchingDescriptor(messageRaw);</span>
<span class="nc" id="L69">            return toJson(message.orElseThrow(RuntimeException::new));</span>
        }

<span class="nc" id="L72">        final Optional&lt;Descriptors.Descriptor&gt; descriptor = cache.getByTypeName(messageTypeName);</span>
<span class="nc" id="L73">        return toJson(messageRaw, descriptor.orElseThrow(() -&gt; new RuntimeException(messageTypeName)));</span>
    }

    @SuppressWarnings(&quot;WeakerAccess&quot;)
    public String toJson(final byte[] messageRaw, final Descriptors.Descriptor descriptor) {
<span class="nc" id="L78">        Objects.requireNonNull(messageRaw);</span>
<span class="nc" id="L79">        Objects.requireNonNull(descriptor);</span>

        try {
<span class="nc" id="L82">            return toJson(DynamicMessage.parseFrom(descriptor, messageRaw));</span>
<span class="nc" id="L83">        } catch (final InvalidProtocolBufferException e) {</span>
<span class="nc" id="L84">            throw new RuntimeException(e);</span>
        }
    }

    @SuppressWarnings(&quot;WeakerAccess&quot;)
    public String toJson(final DynamicMessage message) {
<span class="nc" id="L90">        Objects.requireNonNull(message);</span>

        try {
<span class="nc" id="L93">            return printer.print(message);</span>
<span class="nc" id="L94">        } catch (final InvalidProtocolBufferException e) {</span>
<span class="nc" id="L95">            throw new RuntimeException(e);</span>
        }
    }

    private Optional&lt;DynamicMessage&gt; parseWithBestMatchingDescriptor(final byte[] messageRaw) {
<span class="nc" id="L100">        Objects.requireNonNull(messageRaw);</span>

<span class="nc" id="L102">        return cache.getDescriptors()</span>
<span class="nc" id="L103">                .stream()</span>
<span class="nc" id="L104">                .map(descriptor -&gt; {</span>
                    try {
<span class="nc" id="L106">                        return DynamicMessage.parseFrom(descriptor, messageRaw);</span>
<span class="nc" id="L107">                    } catch (final InvalidProtocolBufferException e) {</span>
                        //noinspection ReturnOfNull
<span class="nc" id="L109">                        return null;</span>
                    }
                })
<span class="nc" id="L112">                .filter(Objects::nonNull)</span>
<span class="nc" id="L113">                .min(Comparator.comparingInt(message -&gt; message.getUnknownFields()</span>
<span class="nc" id="L114">                        .asMap()</span>
<span class="nc" id="L115">                        .size()));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>